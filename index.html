<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>租借定位紀錄</title>
</head>
<body>
  <h2>QR Code 掃碼租借紀錄</h2>
  <div>
    <p><strong>掃描門市：</strong> <span id="storeInfo">讀取中...</span></p>
  </div>

  <div>
    <label for="employeeId">請輸入員工編號：</label>
    <input type="text" id="employeeId" placeholder="員工編號" />
  </div>
  <div>
    <p><strong>姓名：</strong> <span id="empName"></span></p>
    <p><strong>部門：</strong> <span id="empDept"></span></p>
    <p><strong>職稱：</strong> <span id="empTitle"></span></p>
  </div>

  <button onclick="submitRecord()">送出紀錄</button>
  <p id="status"></p>

  <script>
    let storeCode = "";
    let storeName = "";

    window.onload = () => {
      const params = new URLSearchParams(window.location.search);
      const storeParam = params.get('store') || "";

      storeCode = storeParam.substring(0, 3);
      storeName = storeParam.substring(3);

      document.getElementById('storeInfo').textContent = `${storeCode} ${storeName}`;
    };

    async function submitRecord() {
      const status = document.getElementById('status');
      const employeeId = document.getElementById('employeeId').value.trim();

      if (!employeeId) {
        status.textContent = "請輸入員工編號";
        return;
      }

      if (!navigator.geolocation) {
        status.textContent = "此瀏覽器不支援定位功能。";
        return;
      }

      status.textContent = "取得定位中...";

      navigator.geolocation.getCurrentPosition(async position => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const time = new Date().toISOString();

        status.textContent = "正在送出...";

        await fetch("https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec", {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ storeCode, employeeId, lat, lng, time })
        });

        status.textContent = "已送出紀錄，感謝您！";
      }, () => {
        status.textContent = "無法取得您的位置，請確認已允許定位權限。";
      });
    }
  </script>
</body>
</html>
